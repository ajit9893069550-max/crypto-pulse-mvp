<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CryptoPulse | Intelligence Dashboard</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <script>
        (function() {
            const hash = window.location.hash;
            if (hash && hash.includes("access_token=")) {
                const params = new URLSearchParams(hash.replace("#", "?"));
                const accessToken = params.get("access_token");
                const refreshToken = params.get("refresh_token");

                if (accessToken) {
                    localStorage.setItem("supabase_token", accessToken);
                    if (refreshToken) localStorage.setItem("supabase_refresh_token", refreshToken);
                    window.history.replaceState(null, null, window.location.pathname);
                }
            }
        })();
    </script>
    <script>
        // Pass Python variable to JavaScript
        window.BOT_USERNAME = "{{ bot_username }}";
    </script>
</head>
<body>

    <div id="chartModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" style="margin:0; color:var(--text-main);">BTC/USDT Chart</h3>
                <button onclick="closeModal()" class="btn-close">‚úï</button>
            </div>
            <div id="tv_chart_container" style="height: 500px; width: 100%;"></div>
        </div>
    </div>

    <audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.m4a" preload="auto"></audio>

    <div class="dashboard-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                <h3 style="color: var(--text-main);">Signal Filters</h3>
            </div>
            
            <ul id="signalFilters" class="sidebar-nav">
                <li class="nav-item active" data-type="ALL">üåç All Live Signals</li>
                
                <p class="menu-label" style="padding: 10px 20px 5px; color: var(--accent-blue);">Sniper Setups</p>
                <li class="nav-item" data-type="SNIPER_BUY_REVERSAL">üéØ Sniper Buy (Reversal)</li>
                <li class="nav-item" data-type="SNIPER_SELL_REJECTION">üõë Sniper Sell (Reject)</li>
                <li class="nav-item" data-type="MOMENTUM_BREAKOUT">üöÄ Momentum Breakout</li>

                <p class="menu-label" style="padding: 10px 20px 5px; color: var(--accent-blue);">Trend & Volatility</p>
                <li class="nav-item" data-type="GOLDEN_CROSS">üü° Golden Cross</li>
                <li class="nav-item" data-type="DEATH_CROSS">üíÄ Death Cross</li>
                <li class="nav-item" data-type="BB_SQUEEZE">ü§ê Volatility Squeeze</li>
                <li class="nav-item" data-type="VOLUME_SURGE">üìä Volume Surge</li>

                <p class="menu-label" style="padding: 10px 20px 5px; color: var(--accent-blue);">Oscillators</p>
                <li class="nav-item" data-type="RSI_OVERSOLD">üìâ RSI Oversold</li>
                <li class="nav-item" data-type="RSI_OVERBOUGHT">üìà RSI Overbought</li>
                <li class="nav-item" data-type="MACD_BULL_CROSS">üü¢ MACD Bull Cross</li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="top-nav">
                <button id="menuToggle" class="menu-hamburger" title="Open Filters">
                    <span></span><span></span><span></span>
                </button>

                <div class="brand">CryptoPulse <span>Scanner</span></div>
                
                <div class="nav-actions">
                    <button id="themeToggle" class="btn-alerts" title="Toggle Theme" style="background:none; border:none; font-size:18px; cursor:pointer;">üåì</button>
                    <span id="authStatusLink"></span>
                </div>
            </header>

            <div class="content-body">
                
                <section class="display-section">
                    <div class="section-header">
                        <div>
                             <h2 id="currentCategoryTitle" style="margin-bottom: 5px;">All Live Market Signals</h2>
                             <p id="categoryDescription" style="color: var(--text-dim); font-size: 13px; max-width: 600px; line-height: 1.4;">
                                     Monitoring all assets for high-probability setups in real-time.
                             </p>
                        </div>
                        <span class="update-tag" style="font-size: 11px; background: var(--bg-card); padding: 5px 10px; border-radius: 12px; border: 1px solid var(--border-color);">‚ö° Live Updates</span>
                    </div>

                    <div class="table-container">
                        <table id="marketScansTable">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Asset</th>
                                    <th style="width: 10%;">TF</th>
                                    <th style="width: 35%;">Signal Type</th>
                                    <th style="width: 15%;">Age</th>
                                    <th style="width: 15%; text-align: center;">Chart</th>
                                </tr>
                            </thead>
                            <tbody id="marketScansList">
                                <tr><td colspan="5" style="text-align:center; padding:50px;">Initializing scanner...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section> 
                <aside class="alert-sidebar">
                    <div id="telegramLinkSection">
                        <h4 style="color: #0088cc; margin-bottom: 5px; display: flex; align-items: center;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" width="20" style="margin-right: 8px;">
                            Telegram Alerts
                        </h4>
                        <p style="font-size: 12px; margin-bottom: 12px; color: var(--text-dim);">Get instant notifications on your phone.</p>
                        <a id="connectTelegramBtn" href="#" target="_blank" class="btn-create" style="display: block; text-align: center; background-color: #0088cc; text-decoration: none; font-size: 13px; border: none; padding: 10px;">
                            Link Telegram Bot
                        </a>
                    </div>

                    <div class="card">
                        <h3 style="color: var(--accent-green); margin-bottom: 15px; font-size: 16px;">üöÄ Create New Alert</h3>
                        <form id="createAlertForm">
                            <div class="input-group">
                                <label class="menu-label">Asset</label>
                                <select id="alertAsset" required>
                                    <option value="BTC/USDT">Bitcoin (BTC)</option>
                                    <option value="ETH/USDT">Ethereum (ETH)</option>
                                    <option value="SOL/USDT">Solana (SOL)</option>
                                    <option value="XRP/USDT">Ripple (XRP)</option>
                                    <option value="ADA/USDT">Cardano (ADA)</option>
                                    <option value="BNB/USDT">Binance Coin (BNB)</option>
                                    <option value="DOGE/USDT">Dogecoin (DOGE)</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label class="menu-label">Timeframe</label>
                                <select id="alertTimeframe" required>
                                    <option value="15m">15 Minutes</option>
                                    <option value="1h">1 Hour</option>
                                    <option value="4h">4 Hours</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label class="menu-label">Signal Type</label>
                                <select id="alertType" required onchange="togglePriceInput()">
                                    <option value="PRICE_TARGET">üí∞ Price Alert (Target)</option>
                                    <optgroup label="Sniper Setups">
                                        <option value="SNIPER_BUY_REVERSAL">üéØ Sniper Buy</option>
                                        <option value="SNIPER_SELL_REJECTION">üõë Sniper Sell</option>
                                        <option value="MOMENTUM_BREAKOUT">üöÄ Breakout</option>
                                    </optgroup>
                                    <optgroup label="Technical Indicators">
                                        <option value="GOLDEN_CROSS">Golden Cross</option>
                                        <option value="RSI_OVERSOLD">RSI Oversold</option>
                                        <option value="MACD_BULL_CROSS">MACD Bull Cross</option>
                                        <option value="BB_SQUEEZE">Bollinger Squeeze</option>
                                    </optgroup>
                                </select>
                            </div>

                            <div class="input-group" id="priceInputGroup" style="display: none;">
                                <label class="menu-label" style="color: var(--accent-green);">Target Price ($)</label>
                                <input type="number" id="alertPrice" step="any" placeholder="e.g. 95000" 
                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-dark); color: var(--text-main); font-weight: bold;">
                            </div>

                            <button type="submit" class="btn-create">Activate Alert</button>
                        </form>
                        <div id="createAlertStatus" style="margin-top:10px; text-align:center; font-size:12px;"></div>
                    </div>

                    <div class="card" style="margin-top: 25px;">
                        <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--text-main);">üìã My Active Alerts</h3>
                        <div id="myAlertsList">
                            <p style="color: var(--text-dim); font-size: 13px;">No active alerts.</p>
                        </div>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="{{ url_for('static', filename='auth.js') }}"></script>
    <script src="{{ url_for('static', filename='api.js') }}"></script>
    <script src="{{ url_for('static', filename='ui.js') }}"></script>
</body>
</html>