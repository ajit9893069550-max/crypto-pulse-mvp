<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CryptoPulse | Intelligence Dashboard</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <script>
        (function() {
            const hash = window.location.hash;
            if (hash && hash.includes("access_token=")) {
                const params = new URLSearchParams(hash.replace("#", "?"));
                const accessToken = params.get("access_token");
                const refreshToken = params.get("refresh_token");

                if (accessToken) {
                    // Save to localStorage for frontend API calls
                    localStorage.setItem("supabase_token", accessToken);
                    if (refreshToken) localStorage.setItem("supabase_refresh_token", refreshToken);
                    
                    console.log("OAuth Login Successful. Token saved.");
                    
                    // Clean the URL hash without reloading to prevent "Unexpected token <" errors
                    window.history.replaceState(null, null, "/");
                }
            }
        })();
    </script>
</head>
<body>

    <div class="dashboard-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Signal Filters</h3>
            </div>
            
            <ul id="signalFilters" class="sidebar-nav">
                <li class="nav-item active" data-type="ALL">üåç All Live Signals</li>
                
                <p class="menu-label">Trend Following</p>
                <li class="nav-item" data-type="GOLDEN_CROSS">üü° Golden Cross</li>
                <li class="nav-item" data-type="DEATH_CROSS">üíÄ Death Cross</li>
                <li class="nav-item" data-type="EMA_20_PULLBACK">üîÑ EMA 20 Pullback</li>
                <li class="nav-item" data-type="NEW_HIGH">üöÄ New 24h High</li>

                <p class="menu-label">Momentum & RSI</p>
                <li class="nav-item" data-type="RSI_OVERSOLD">üìâ RSI Oversold</li>
                <li class="nav-item" data-type="RSI_OVERBOUGHT">üìà RSI Overbought</li>
                <li class="nav-item" data-type="RSI_BULLISH_DIV">‚öñÔ∏è RSI Bullish Div</li>
                <li class="nav-item" data-type="STOCH_RSI_BULLISH">‚ö° Stoch RSI Bullish</li>

                <p class="menu-label">MACD Signals</p>
                <li class="nav-item" data-type="MACD_BULL_CROSS">üü¢ MACD Bull Cross</li>
                <li class="nav-item" data-type="MACD_BEAR_CROSS">üî¥ MACD Bear Cross</li>

                <p class="menu-label">Volatility & Volume</p>
                <li class="nav-item" data-type="BB_SQUEEZE">ü§ê BB Squeeze</li>
                <li class="nav-item" data-type="BB_UPPER_BREAKOUT">‚òÅÔ∏è BB Upper Breakout</li>
                <li class="nav-item" data-type="BB_LOWER_TOUCH">‚òÅÔ∏è BB Lower Touch</li>
                <li class="nav-item" data-type="BULLISH_ENGULFING">üïØÔ∏è Bullish Engulfing</li>
                <li class="nav-item" data-type="VOLUME_SURGE">üìä Volume Surge</li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="top-nav">
                <button id="menuToggle" class="menu-hamburger" title="Open Filters">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>

                <div class="brand">CryptoPulse <span>Scanner</span></div>
                
                <div class="nav-actions">
                    <button id="themeToggle" class="btn-alerts" title="Toggle Light/Dark Mode">üåì</button>
                    <span id="authStatusLink"></span>
                </div>
            </header>

            <div class="content-body">
                <section class="display-section">
                    <div class="section-header">
                        <h2 id="currentCategoryTitle">All Live Market Signals</h2>
                        <span class="update-tag">Updates every 60s (IST)</span>
                    </div>

                    <div class="table-container">
                        <table id="marketScansTable">
                            <thead>
                                <tr>
                                    <th>Asset</th>
                                    <th>TF</th>
                                    <th>Signal Type</th>
                                    <th>Detected At</th>
                                </tr>
                            </thead>
                            <tbody id="marketScansList">
                                <tr><td colspan="4" style="text-align:center; padding:50px;">Initializing scanner...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <aside class="alert-sidebar">
                    <div id="telegramLinkSection">
                        <h4 style="color: #0088cc; margin-bottom: 5px; display: flex; align-items: center;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" width="20" style="margin-right: 8px;">
                            Telegram Alerts
                        </h4>
                        <p style="font-size: 12px; margin-bottom: 12px; color: var(--text-dim);">Get instant notifications on your phone.</p>
                        <a id="connectTelegramBtn" href="#" target="_blank" class="btn-create" style="display: block; text-align: center; background-color: #0088cc; text-decoration: none; font-size: 13px; border: none; padding: 10px;">
                            Link Telegram Bot
                        </a>
                    </div>

                    <div class="card">
                        <h3 style="color: var(--accent-green); margin-bottom: 15px; font-size: 16px;">üöÄ Create New Alert</h3>
                        <form id="createAlertForm">
                            <div class="input-group">
                                <label class="menu-label">Asset</label>
                                <select id="alertAsset" class="btn-alerts" required>
                                    <option value="BTC/USDT">Bitcoin (BTC)</option>
                                    <option value="ETH/USDT">Ethereum (ETH)</option>
                                    <option value="SOL/USDT">Solana (SOL)</option>
                                    <option value="XRP/USDT">Ripple (XRP)</option>
                                    <option value="ADA/USDT">Cardano (ADA)</option>
                                    <option value="BNB/USDT">Binance Coin (BNB)</option>
                                    <option value="DOGE/USDT">Dogecoin (DOGE)</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label class="menu-label">Timeframe</label>
                                <select id="alertTimeframe" class="btn-alerts" required>
                                    <option value="15m">15 Minutes</option>
                                    <option value="1h">1 Hour</option>
                                    <option value="4h">4 Hours</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label class="menu-label">Signal Type</label>
                                <select id="alertType" class="btn-alerts" required>
                                    <option value="GOLDEN_CROSS">Golden Cross</option>
                                    <option value="RSI_OVERSOLD">RSI Oversold</option>
                                    <option value="MACD_BULL_CROSS">MACD Bull Cross</option>
                                    <option value="BB_SQUEEZE">Bollinger Squeeze</option>
                                    <option value="VOLUME_SURGE">Volume Surge</option>
                                </select>
                            </div>

                            <button type="submit" class="btn-create" style="width:100%; padding:12px; font-weight: bold;">Activate Alert</button>
                        </form>
                        <div id="createAlertStatus" style="margin-top:10px; text-align:center; font-size:12px;"></div>
                    </div>

                    <div class="card" style="margin-top: 25px;">
                        <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--text-main);">üìã My Active Alerts</h3>
                        <div id="myAlertsList">
                            <p style="color: var(--text-dim); font-size: 13px;">No active alerts.</p>
                        </div>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="{{ url_for('static', filename='scripts.js') }}"></script>
</body>
</html>